name: Simple CD after CI with DAST

on:
  workflow_run:
    workflows: ["Microservices CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    # Only run if the CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/vote vote=${{ secrets.DOCKER_HUB_USERNAME }}/vote-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl set image deployment/result result=${{ secrets.DOCKER_HUB_USERNAME }}/result-find-your-bias:${{ github.event.workflow_run.head_sha }}
          kubectl set image deployment/worker worker=${{ secrets.DOCKER_HUB_USERNAME }}/worker-find-your-bias:${{ github.event.workflow_run.head_sha }}

          kubectl rollout status deployment/vote
          kubectl rollout status deployment/result
          kubectl rollout status deployment/worker

      # --- In-Cluster DAST Stage ---
      # - name: Run OWASP ZAP inside Kubernetes
      #   run: |
      #     echo "Starting OWASP ZAP scan against vote service (port 8080)..."
          
      #     # Create a temp ZAP scan pod
      #     kubectl run zap-scan \
      #       --image=owasp/zap2docker-stable \
      #       --restart=Never \
      #       --command -- \
      #       zap-baseline.py \
      #       -t http://vote:8080 \
      #       -r /tmp/zap_report.html \
      #       -m 5

      #     # Wait for pod to complete
      #     kubectl wait --for=condition=complete pod/zap-scan --timeout=300s

      #     # Copy the report from pod to local
      #     kubectl cp zap-scan:/tmp/zap_report.html ./zap_report.html

      #     # Cleanup the pod
      #     kubectl delete pod zap-scan

      # - name: Upload DAST Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dast-report
      #     path: zap_report.html
